#!/usr/bin/env bash
set -euo pipefail

DWIM_LOG="${DWIM_LOG:-$HOME/.local/share/dwim/usage.log}"
DWIM_USER_COMMANDS="${DWIM_USER_COMMANDS:-$HOME/.config/dwim/commands}"
DWIM_LOCAL_COMMANDS="./.dwim/commands"

# Handle install subcommand before logging
if [[ "${1:-}" == "install" ]]; then
  target="$HOME/.local/bin/dwim"
  source="$(realpath "${BASH_SOURCE[0]}")"

  mkdir -p "$HOME/.local/bin"

  if [[ -L "$target" ]]; then
    existing="$(readlink "$target")"
    if [[ "$existing" == "$source" ]]; then
      echo "dwim: already installed at $target"
      exit 0
    fi
    echo "dwim: updating symlink (was: $existing)"
    rm "$target"
  elif [[ -e "$target" ]]; then
    echo "dwim: $target exists and is not a symlink, aborting"
    exit 1
  fi

  ln -s "$source" "$target"
  echo "dwim: installed $target -> $source"
  exit 0
fi

# Ensure log directory exists
mkdir -p "$(dirname "$DWIM_LOG")"

# Log the attempt
echo "$(date -Iseconds) [$$] $(pwd) $*" >> "$DWIM_LOG"

# No arguments? Show brief help.
if [[ $# -eq 0 ]]; then
  echo "usage: dwim <intent> [args...]"
  echo "       dwim install    # symlink to ~/.local/bin/dwim"
  exit 0
fi

# Check for native implementation (user-level)
if [[ -x "$DWIM_USER_COMMANDS/$1" ]]; then
  exec "$DWIM_USER_COMMANDS/$1" "${@:2}"
fi

# Check for native implementation (project-local)
if [[ -x "$DWIM_LOCAL_COMMANDS/$1" ]]; then
  exec "$DWIM_LOCAL_COMMANDS/$1" "${@:2}"
fi

# Fall back to LLM interpretation
exec claude -p "You are dwim (Do What I Mean), a CLI intent interpreter.

The user invoked: dwim $*
Working directory: $(pwd)

If the intent is clear, execute it and return the result.
If the intent is ambiguous, write clarifying questions to a temp file and return instructions for 'dwim retry'.
If you can infer a reusable pattern, note it for potential native implementation.

Be concise. Execute, don't explain."
